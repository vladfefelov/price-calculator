<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор цены за кг</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.0.2/tesseract.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .container { max-width: 400px; margin: auto; }
        .hidden { display: none; }
        input { width: 100%; padding: 10px; margin: 5px 0; font-size: 18px; }
        button { padding: 10px; width: 100%; margin: 5px 0; font-size: 18px; }
        .blue { background-color: blue; color: white; }
        .red { background-color: red; color: white; }
        table { width: 100%; margin-top: 10px; border-collapse: collapse; }
        th, td { border: 1px solid black; padding: 8px; text-align: center; }
        .green { background-color: lightgreen; }
        .red-bg { background-color: lightcoral; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Калькулятор цены за кг</h2>
        <label>
            <input type="radio" name="mode" value="manual" checked onclick="toggleMode()"> Ручной ввод
        </label>
        <label>
            <input type="radio" name="mode" value="auto" onclick="toggleMode()"> Автоматический
        </label>

        <div id="manual-input">
            <input type="number" id="price" placeholder="Цена (тг)" inputmode="numeric">
            <input type="number" id="weight" placeholder="Вес (гр)" inputmode="numeric">
            <button class="blue" onclick="calculate()">Посчитать</button>
        </div>

        <div id="auto-input" class="hidden">
            <video id="camera" width="100%" autoplay></video>
            <button class="blue" onclick="scanText()">Сканировать</button>
        </div>

        <button class="red" onclick="resetTable()">Сбросить</button>
        
        <table>
            <thead>
                <tr>
                    <th>№</th>
                    <th>Цена (тг)</th>
                    <th>Вес (гр)</th>
                    <th>Цена за кг</th>
                </tr>
            </thead>
            <tbody id="result"></tbody>
        </table>
    </div>

    <script>
        let counter = 1;

        function calculate(price, weight) {
            if (!price || !weight) {
                price = document.getElementById("price").value;
                weight = document.getElementById("weight").value;
            }

            if (price && weight) {
                let pricePerKg = Math.round((price / weight) * 1000);
                let table = document.getElementById("result");
                let row = table.insertRow();
                row.insertCell(0).innerText = counter++;
                row.insertCell(1).innerText = price;
                row.insertCell(2).innerText = weight;
                row.insertCell(3).innerText = pricePerKg;
                highlightRows();
            }
        }

        function resetTable() {
            document.getElementById("result").innerHTML = "";
            counter = 1;
        }

        function highlightRows() {
            let rows = document.getElementById("result").rows;
            if (rows.length < 2) return;

            let prices = [];
            for (let row of rows) {
                prices.push(parseInt(row.cells[3].innerText));
            }

            let minPrice = Math.min(...prices);
            let maxPrice = Math.max(...prices);

            for (let row of rows) {
                let price = parseInt(row.cells[3].innerText);
                row.classList.remove("green", "red-bg");
                if (price === minPrice) row.classList.add("green");
                if (price === maxPrice) row.classList.add("red-bg");
            }
        }

        function toggleMode() {
            let manual = document.getElementById("manual-input");
            let auto = document.getElementById("auto-input");
            if (document.querySelector('input[name="mode"]:checked').value === "manual") {
                manual.classList.remove("hidden");
                auto.classList.add("hidden");
                stopCamera();
            } else {
                manual.classList.add("hidden");
                auto.classList.remove("hidden");
                startCamera();
            }
        }

        function startCamera() {
            let video = document.getElementById("camera");
            navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                video.srcObject = stream;
            }).catch(error => {
                alert("Ошибка: не удалось получить доступ к камере.");
            });
        }

        function stopCamera() {
            let video = document.getElementById("camera");
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        function scanText() {
            let video = document.getElementById("camera");
            let canvas = document.createElement("canvas");
            let context = canvas.getContext("2d");

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            Tesseract.recognize(canvas, "eng", { logger: m => console.log(m) }).then(({ data: { text } }) => {
                let numbers = text.match(/\d+/g);
                if (numbers && numbers.length >= 2) {
                    let price = numbers[0];
                    let weight = numbers[1];
                    calculate(price, weight);
                } else {
                    alert("Не удалось распознать цену и вес. Попробуйте снова.");
                }
            });
        }
    </script>
</body>
</html>